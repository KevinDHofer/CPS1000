library(ggplot2)
library(ggrepel)
library(dplyr)
library(tidyverse)

usedSamples_all <- read.csv("~/Dropbox/Medizin/Forschung/Aktuelle Forschungsprojekte/CLL CPS1000/raw data/usedSamples_all.csv", sep=";")

viability_table <- read.csv2("~/Dropbox/Medizin/Forschung/Aktuelle Forschungsprojekte/CLL CPS1000/raw data/viability_table.csv")

load("~/Dropbox/Medizin/Forschung/Aktuelle Forschungsprojekte/CLL CPS1000/raw data/patmeta_210324.RData")

#load table with disease entities  
diseases <- usedSamples_all |> 
  arrange(patientID) |> 
  dplyr::select (patientID, diagnosis) 
diseases

# merge the tables
merged_table <- cbind(diseases, viability_table) |> 
  relocate(diagnosis, .before = X10058.F4_1)
merged_table

#transfrom in long data frame
merged_table_long <- merged_table |>
  pivot_longer(cols = c(4:318), names_to = "drug", values_to = "viability")
merged_table_long

#remove last two characters from each string in 'drug' column
merged_table_long$drug <- str_sub(merged_table_long$drug, end = -3)
merged_table_long

#create means
means <- merged_table_long |> 
  group_by(patientID, drug, diagnosis) |> 
  summarize(mean(viability))
means

#filter for CLL
means_cll <- means |>
  filter(str_detect(diagnosis, "CLL"))
  
#merge with patMeta
means_merged <- merge(means_cll, patMeta, by.x="patientID", by.y = "Patient.ID")

#filter for U-CLL
#means_merged_U <- means_merged |> filter(IGHV.status == "U")
    
#create new table with genetic information: mean-tr12 and mean-nontri12
df_tri12 <- means_merged |> 
  group_by(trisomy12, drug) |> 
    dplyr::rename(viab = "mean(viability)") |> 
    summarize(mean(viab)) |> 
      ungroup()
      
df_tri12 <- na.omit(df_tri12)


#calculate difference in viability instead of log2fc
df_wide <- pivot_wider(df_tri12, names_from = "trisomy12", values_from = "mean(viab)") |> 
  dplyr::rename(tri12 = "1", none = "0")

df_1 <- df_wide|> 
  mutate(diff_viab = (tri12-none)/(tri12)*100)

#normalize? > not possible with log > use wilcoxon  
hist(df_1$diff_viab)  
hist(log(df_1$diff_viab))
  
# Perform t-test to get p-values
means_merged <- means_merged |> 
  arrange(drug)

p_value = sapply(means_merged$drug, function(d) {
      tri12_yes <- means_merged %>% 
        filter(trisomy12 == "1" & drug == d) %>% 
        pull("mean(viability)")
      tri12_no <- means_merged %>% 
        filter(trisomy12 == "0" & drug == d) %>% 
        pull("mean(viability)")
      wilcox.test(tri12_yes, tri12_no)$p.value
    })
    
# Calculate -log10 of p-value for y-axis
p_value <- as.vector(p_value)
means_merged$neg_log10_p <- -log10(p_value)
  
#combine with df_1
df_2 <- means_merged |> 
  group_by(drug) |> 
    summarize(mean(neg_log10_p)) |> 
    ungroup()
    
df_3 <- merge(df_1,df_2, by = "drug") |> 
  dplyr::rename(p_val = "mean(neg_log10_p)")

# Create the volcano plot
set.seed(123)

dat <- subset(df_3, diff_viab > -40 & diff_viab < 10)
dat$drug <- df_3$drug
dat <-  dat |> 
  mutate(sig = case_when(p_val>(-log10(0.05)) ~ 1,
    TRUE ~ 0))

#integrate colors for pathway
library(RColorBrewer)

drugCategory_modified <- read.csv("~/Dropbox/Medizin/Forschung/Aktuelle Forschungsprojekte/CLL CPS1000/analysis/drugCategory_modified.csv", sep=";")

df_3<- merge(df_3, drugCategory_modified[,c(2,6)], by = "drug")

mycolors <- colorRampPalette(brewer.pal(12, "Paired"))(14)

#use colors from Fig2
annotation_colors_row <- setNames(c("lightgrey", "#FCCDE5", "#B3DE69", "#FDB462", "#80B1D3", "#FB8072", "#BEBADA", "#FFFFB3", "#8DD3C7", "#A6CEE3", "#6DBD57", "#DE9E83", "#BC80BD"), c("other", "DNA damage response", "Chemotherapy" ,  "MAPK" , "B-cell receptor", "PI3K", "Stress pathway", "Bromodomain/PLK", "JAK/STAT", "Apoptosis", "Cell cycle control", "Histone methylation", "PI3K/AKT/mTOR"))  

pways <- as.vector(unlist(df_3[,"Pathway_mod2"]))
pways <- sort(unique(pways))
pways <- pways[-10]
pways <- append(pways, "other")

df_3$Pathway_mod2 <- factor(df_3$Pathway_mod2, levels = pways)

#add number of sign. differences
#add concentration levels
merged_table_long$level <- c(rep(seq(1:5), nrow(merged_table_long)/5))

#filter for CLL
cll <- merged_table_long |>
  filter(str_detect(diagnosis, "CLL"))
  
#merge with patMeta
merged <- merge(cll, patMeta, by.x="patientID", by.y = "Patient.ID")

#create new table with genetic information: meanM and meanU
df_tri <- merged |> 
  group_by(drug, level, trisomy12) |> 
    dplyr::rename(viab = viability) |> 
    summarize(mean(viab)) |> 
      ungroup()

df_tri <- df_tri |> 
  na.omit(trisomy12)

#calculate difference in viability instead of log2fc
df_wide_tri <- pivot_wider(df_tri, names_from = "trisomy12", values_from = "mean(viab)") 
  
# Perform wilxocon to get p-values for all levels
# Calculate p-values for each drug and level
p_values <- merged %>%
  group_by(drug, level) %>%
  summarise(
    p_value = tryCatch(
      wilcox.test(
        viability[trisomy12 == "1"], 
        viability[trisomy12 == "0"]
      )$p.value,
      error = function(e) NA
    ),
    mean_yes = mean(viability[trisomy12 == "1"], na.rm = TRUE),
    mean_no = mean(viability[trisomy12 == "0"], na.rm = TRUE)
  ) %>%
  ungroup() %>%
  # Adjust p-values for multiple comparisons
  mutate(
    p_adjusted = p.adjust(p_value, method = "fdr")
  ) %>%
  # Sort by adjusted p-value
  arrange(p_adjusted)

# Print the results
print(p_values)

# Count significant p-values per drug
# You can adjust the significance threshold as needed (e.g., 0.05 or 0.01)
significant_counts <- p_values %>%
    mutate(count = case_when(p_value < 0.05 ~ 1, TRUE ~ 0)) |> 
      group_by(drug) |> 
        summarize(nr_count = sum(count)) |> 
          ungroup()
          
#merge
df_4m <- merge(df_3, significant_counts, by = "drug") |> 
  group_by(drug)
          
#plot5
set.seed(123)
plot5 <- ggplot(df_4m, aes(x = diff_viab, y = p_val, label=drug)) +
  geom_hline(yintercept = -log10(0.05), 
             linetype = "dashed", 
             color = "black") +
  geom_vline(xintercept = 0, 
             color = "black") +
  geom_point(aes(color=Pathway_mod2, size=nr_count), alpha = 0.8) +
    geom_text_repel(
    text.padding = 0.5,
    box.padding = 0.5,
    max.overlaps = 10, 
    min.segment.length = 1,
    size=3
)+
  theme_classic() +
  labs(
    title = "trisomy12",
    x = "Difference in mean viability (%)",
    y = expression(-log[10]*italic(P))
  ) +
    scale_x_continuous(limits = c(-20, 20)) +
    scale_color_manual(values=annotation_colors_row)+
    labs(color="Pathway", size="Number of sign. \ndifferent concentrations") +
    guides(color = guide_legend(override.aes = list(size = 4)))+
    theme(plot.title = element_text(hjust=0.5, size=8, face="bold"), 
    axis.text.x = element_text(color="black", size=8), 
    axis.text.y = element_text(color="black", size=8),
    axis.title = element_text(color="black", size=8),
    legend.title = element_text(size=8, face="bold"),
    legend.text=element_text(size=8),
    axis.line = element_line(size = 0.5))+
    annotate("text", label="more active\nin trisomy12", y=8, x=-10, size=3)+
    annotate("text", label="more active\nin wt", y=8, x=10, size=3)

Fig5c <- plot5 + theme(plot.margin = margin(t=1, l=1, unit = "cm"))
Fig5c
