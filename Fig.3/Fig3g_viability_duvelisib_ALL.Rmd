library(tidyverse)
library(plotrix)

#load data
usedSamples_all <- read.csv("~/Dropbox/Medizin/Forschung/Aktuelle Forschungsprojekte/CLL CPS1000/raw data/usedSamples_all.csv", sep=";")

viability_table <- read.csv2("~/Dropbox/Medizin/Forschung/Aktuelle Forschungsprojekte/CLL CPS1000/raw data/viability_table.csv")

#load table with disease entities  
diseases <- usedSamples_all |> 
  arrange(patientID) |> 
  dplyr::select (patientID, diagnosis) 
diseases

# merge the tables
merged_table <- cbind(diseases, viability_table) |> 
  relocate(diagnosis, .before = X10058.F4_1)
merged_table

#transfrom in long data frame
merged_table_long <- merged_table |>
  pivot_longer(cols = c(4:318), names_to = "drug", values_to = "viability")
merged_table_long

#focus on main diseases
merged_filtered <- merged_table_long
#|>filter(str_detect(diagnosis, "CLL") | str_detect(diagnosis, "MCL") |         str_detect(diagnosis, "AML") | str_detect(diagnosis, "B-ALL") | str_detect(diagnosis, "T-ALL") | str_detect(diagnosis, "B-PLL")  | str_detect(diagnosis, "T-PLL"))
merged_filtered 


#remove last two characters from each string in 'drug' column
merged_filtered<- merged_filtered |> 
  mutate(drug_sub = str_sub(merged_filtered$drug, end = -3)) |> 
    filter(diagnosis != "")

#select duvelisib and diseases
merged_filtered <- merged_filtered |> 
    filter(drug_sub == "Duvelisib") |> 
    filter(diagnosis == "B-ALL" | diagnosis == "T-ALL") |> 
    mutate(drug = fct_recode(drug, "0.0032" = "Duvelisib_1",
"0.016" = "Duvelisib_2", "0.08" = "Duvelisib_3", "0.4" = "Duvelisib_4", "2" = "Duvelisib_5"))

#change order
merged_filtered$diagnosis <- as.factor(merged_filtered$diagnosis)

#set colors
mycolors <- setNames(c("#1F78B4", "#B2DF8A", "#33A02C", "grey", "#E31A1C", "#FB9A99", "#FF7F00", "#CAB2D6"), c("CLL", "B-PLL", "T-PLL", "other", "AML", "T-ALL", "B-ALL", "MCL"))

#plot for duvelisib
plot <- merged_filtered |>
    ggplot(aes(x=rev(factor(drug)), y=viability, color=diagnosis)) +
    geom_boxplot(outlier.shape = NA)+
    geom_jitter(size=1, alpha = 0.25, position = position_jitterdodge())+
    labs(title="Duvelisib (PI3K)",x="concentration [uM]", y = "viability")+
    scale_y_continuous(breaks=seq(0,1.0, 0.2), limits=c(0,1.1))+
    theme_classic()+
#stat_summary(fun.y = median, geom = 'line', aes(group = diagnosis, colour = diagnosis), position = position_dodge(width = 0.9))+
    scale_color_manual(values=mycolors)+
    labs(y="Viability", x=bquote("Concentration ("*mu*"M)"), color = "Diagnosis")+
theme(legend.position = "right", legend.title=element_text(size=8, face="bold"), legend.text = element_text(size=8), axis.text.x = element_text(angle = 45, hjust=1, color="black", size=8), axis.text.y = element_text(color="black", size=8), axis.line = element_line(size = 0.5), 
axis.title.y = element_text(size=8), axis.title.x = element_text(size=8), plot.title = element_text(hjust=0.5, size=8, face="bold"), legend.key.size = unit(0.5, 'cm'), plot.margin = margin(r = 1, l=1, unit = "cm"))

Fig3g <- plot
Fig3g
