library(tidyverse)
library(dplyr)
library(ggplot2)
library(ggrepel)
library(patchwork)
library(readxl)
library(tidyverse)
library(dplyr)
library(plotrix)
library(drc)
library(scales)
library(corrplot)
library(leaps)
library(glmnet)
library(tidyverse)
library(ggplot2)
library(dendextend)
library(stats)

#load tables
usedSamples_all <- read.csv("~/Dropbox/Medizin/Forschung/Aktuelle Forschungsprojekte/CLL CPS1000/raw data/usedSamples_all.csv", sep=";")
  
viability_table <- read.csv2("~/Dropbox/Medizin/Forschung/Aktuelle Forschungsprojekte/CLL CPS1000/raw data/viability_table.csv")
  
ORR_CLL <- read_excel("~/Dropbox/Medizin/Forschung/Aktuelle Forschungsprojekte/CLL CPS1000/analysis/clinical_responses_AML_CLL_20250707.xlsx", sheet = "CLL") 

ORR_CLL <- ORR_CLL[,1:7]

ORR_AML <- read_excel("~/Dropbox/Medizin/Forschung/Aktuelle Forschungsprojekte/CLL CPS1000/analysis/clinical_responses_AML_CLL_20250707.xlsx", sheet = "AML")

ORR_AML <- ORR_AML[,1:7]
  
#load table with disease entities  
diseases <- usedSamples_all |> 
  arrange(patientID) |> 
  dplyr::select (patientID, diagnosis) 
diseases
  
# merge the tables
merged_table <- cbind(diseases, viability_table) |> 
  relocate(diagnosis, .before = X10058.F4_1)
merged_table
  
#transfrom in long data frame
merged_table_long <- merged_table |>
  pivot_longer(cols = c(4:318), names_to = "drug", values_to = "viability")
merged_table_long

#remove last two characters from each string in 'drug' column
merged_table_long$drug <- str_sub(merged_table_long$drug, end = -3)
merged_table_long <- merged_table_long |> 
  mutate(conc_level=rep(seq(1,5), times=nrow(merged_table_long)/5)) 
  
#remove empty diagnosis  |> 
merged_table_long <- merged_table_long |> 
  dplyr::filter(diagnosis != "")

#add concentration values for each drug, log-transform
#select drugs with concentration A (plates 1 to 4)
groupA <- merged_table_long |> 
  dplyr::filter(drug %in% c("Cisplatin", "Imatinib", "A.1210477", "Nutlin.3a", 
                            "RO5963", "TW.37", "AZD1208", "Fludarabine", 
                            "Methotrexate", "OTX015", "Sunitinib", "Volasertib", 
                            "BGJ398", "Afatinib", "Cytarabine", "IRAK1.4.Inhibitor.I", 
                            "Olaparib", "Selisistat", "Vismodegib", "BML.277", 
                            "Foretinib", "MI.503", "Palbociclib", "Tozasertib"))                     

concentration_A <- rep(c(10, 2, 0.4, 0.08, 0.016), times = 10920)

df_A <- cbind(groupA, concentration_A) |> 
  dplyr::rename(concentration = concentration_A)
df_A

#select drugs with concentration B (plate 1 to 4)
groupB <- merged_table_long |> 
  dplyr::filter(drug %in% c("A.674563", "BMS.509744", "Dabrafenib", "Ganetespib", 
                            "KU.55933", "Motolimod", "PF.3758309", "Ruxolitinib", 
                            "SGC.0946", "AZD6738", "Cobimetinib", "Duvelisib", 
                            "Idelalisib", "Midostaurin", "Quizartinib", "SCH772984", 
                            "Trametinib", "AMI.1", "Ceritinib", "Dasatinib", 
                            "Ibrutinib", "Menin.MLL.Inhibitor", "Onalespib", 
                            "PRT062607", "SB.203580", "Tofacitinib", "EPZ.6438", 
                            "JNK.IN.8", "MK.2206", "ONO.4059", "Rapamycin", 
                            "X10058.F4", "AZD8055", "D4476", "Selinexor", "ZM.336372"))                 
  
concentration_B <- rep(c(2, 0.4, 0.08, 0.016, 0.0032), times = 16380)

df_B <- cbind(groupB, concentration_B)  |> 
  dplyr::rename(concentration = concentration_B)
df_B

#select drugs with concentration C (plates 1 to 4)
groupC <- merged_table_long |> 
  dplyr::filter(drug %in% c("Panobinostat", "Venetoclax", "Doxorubicine"))
  
concentration_C <- rep(c(0.4, 0.08, 0.016, 0.0032, 0.00064), times = 1365)

df_C <- cbind(groupC, concentration_C)  |> 
  dplyr::rename(concentration = concentration_C)
df_C

#combine all tables
df_all <- rbind(df_A, df_B, df_C)

#cap supravital viability results (cut-off <1.2)
df_all$viability[df_all$viability >1.2] <-1.2

# only select diseases with at least five cases
diagSelected <- c("CLL", "AML", "B-ALL", "T-ALL", "B-PLL", "T-PLL", "MCL")

#create means
viabTab.mean <- merged_table_long |> 
  dplyr::filter(diagnosis %in% diagSelected) |> 
  group_by(patientID, diagnosis, drug) |> 
    summarize(viab = mean(viability))
    
##CLL and non-CLL 
viabTab.mean.cll <- viabTab.mean |> 
  mutate(diagnosis = ifelse(diagnosis == "CLL", diagnosis, "non-CLL"))
unique(viabTab.mean.cll$diagnosis)

##AML and non-AML 
viabTab.mean.aml <- viabTab.mean |> 
  mutate(diagnosis = ifelse(diagnosis == "AML", diagnosis, "non-AML"))
unique(viabTab.mean.aml$diagnosis)

#create p-values
tTest <- function(val, fac) {
  res <- t.test(val ~ fac, var.equal = TRUE)
  data.frame(p = res$p.value, 
             mean1 = res$estimate[[1]],
             mean2 = res$estimate[[2]],
             diff = res$estimate[[2]] - res$estimate[[1]])
}

#CLL
allDiag.cll <- unique(viabTab.mean.cll$diagnosis)
pTabAll.cll <- lapply(allDiag.cll, function(diagBase) {
  #calculate p value matrix
  pTab <- lapply(allDiag.cll[allDiag.cll != diagBase], function(diagCompare) {
    testTab <- dplyr::filter(viabTab.mean.cll, diagnosis %in% c(diagBase, diagCompare)) %>%
      mutate(diagnosis = factor(diagnosis, levels = c(diagBase,diagCompare))) 
    res <- group_by(testTab, drug) %>% do(tTest(.$viab, .$diagnosis)) %>%
      mutate(diagCompare = diagCompare, diagBase = diagBase)
    res
  }) %>% bind_rows() %>% ungroup() %>% mutate(p.adj = p.adjust(p, method = "BH"))
}) %>% bind_rows()

#AML
allDiag.aml <- unique(viabTab.mean.aml$diagnosis)
pTabAll.aml <- lapply(allDiag.aml, function(diagBase) {
  #calculate p value matrix
  pTab <- lapply(allDiag.aml[allDiag.aml != diagBase], function(diagCompare) {
    testTab <- dplyr::filter(viabTab.mean.aml, diagnosis %in% c(diagBase, diagCompare)) %>%
      mutate(diagnosis = factor(diagnosis, levels = c(diagBase,diagCompare))) 
    res <- group_by(testTab, drug) %>% do(tTest(.$viab, .$diagnosis)) %>%
      mutate(diagCompare = diagCompare, diagBase = diagBase)
    res
  }) %>% bind_rows() %>% ungroup() %>% mutate(p.adj = p.adjust(p, method = "BH"))
}) %>% bind_rows()

#prepare data table for plot 
plotTab.cll <- pTabAll.cll %>% 
#mutate(p = ifelse(p < 1e-12, 1e-12, p)) %>%
  mutate(pSign = -log10(p)*sign(diff)) %>%
#mutate(pSign = ifelse(p.adj < 0.1, pSign, 0)) %>%
  ungroup()
  
plotTab.aml <- pTabAll.aml %>% 
#mutate(p = ifelse(p < 1e-12, 1e-12, p)) %>%
  mutate(pSign = -log10(p)*sign(diff)) %>%
#mutate(pSign = ifelse(p.adj < 0.1, pSign, 0)) %>%
  ungroup()  
  
#filter for CLL-AML
plotTab.cll <- plotTab.cll |>  dplyr::filter(diagBase == "CLL")
plotTab.aml <- plotTab.aml |>  dplyr::filter(diagBase == "AML")

#filter for drugs with clinical data
ORR_CLL <- ORR_CLL |> 
  dplyr::rename(ORR = "ORR%", CR = "CR%") |> 
  dplyr::filter(ORR != "NA")
ORR_CLL$ORR <- as.numeric(ORR_CLL$ORR)
ORR_CLL$CR <- as.numeric(ORR_CLL$CR) 
  
ORR_AML <- ORR_AML |> 
  dplyr::rename(ORR = "ORR%", CR = "CR%") |> 
  dplyr::filter(ORR != "NA")
ORR_AML$ORR <- as.numeric(ORR_AML$ORR)
ORR_AML$CR <- as.numeric(ORR_AML$CR)  

drug_list <- unique(c(ORR_CLL$drug, ORR_AML$drug))

# Fit sigmoid curve for each drug and each sample
sumData <- df_all |> 
  group_by(patientID, drug, concentration) %>%
  summarise(viab = mean(viability)) |> 
  dplyr::rename(Drug = drug, conc = concentration)

testF <- function(m0, m1) {
  Fstat <- ((sum(residuals(m0)^2) - sum(residuals(m1)^2))/(m0$df.residual-m1$df.residual))/(sum(residuals(m1)^2)/m1$df.residual)
  1 - pf(Fstat, m0$df.residual-m1$df.residual, m1$df.residual)
}

calcAUC <- function(m1, minConc =0, maxConc=15, n=100) {
  concSeq <- data.frame(conc = seq(minConc, maxConc, length.out = n))
  valueConc <- data.frame(viab = predict(m1, concSeq),
                          conc = concSeq[,1])
  valueConc <- valueConc[order(valueConc$conc),]
  areaTotal <- 0
  for (i in seq(nrow(valueConc)-1)) {
    areaEach <- (valueConc$viab[i] + valueConc$viab[i+1])*(valueConc$conc[i+1]-valueConc$conc[i])*0.5
    areaTotal <- areaTotal + areaEach
  }
  areaTotal/(valueConc[nrow(valueConc),]$conc-valueConc[1,]$conc)
}

calcParm <- function(df_input) {
  df <- as.data.frame(df_input)
  df$conc <- as.numeric(df$conc)
  df$viab <- as.numeric(df$viab)

  formula_obj <- viab ~ conc

  out <- tryCatch({
    m1 <- eval(substitute(
      drm(formula_obj,
          data = df,
          fct = LL2.3u(),
          robust = "tukey",
          lowerl = c(0, 0, NA),
          upperl = c(4, 1, NA)),
      list(formula_obj = formula_obj, df = df)
    ))

    fitRes <- m1$coefficients
    m0 <- lm(viab ~ 1, data = df)
    pred_vals <- predict(m1)
    r2 <- cor(pred_vals, df$viab, use = "pairwise.complete.obs")^2
    auc <- calcAUC(m1)

    tibble(
      HS = fitRes[[1]],
      Einf = fitRes[[2]],
      IC50 = fitRes[[3]],
      pF = testF(m0, m1),
      R2 = r2,
      AUC = auc
    )
  }, error = function(e) {
    message("Fit failed for a group: ", e$message)
    tibble(
      HS = NA_real_,
      Einf = NA_real_,
      IC50 = NA_real_,
      pF = NA_real_,
      R2 = NA_real_,
      AUC = NA_real_
    )
  })

  return(out)
}

ic50Tab <- sumData %>%
  group_by(patientID, Drug) %>% nest() %>%
  mutate(mm = map(data, calcParm)) %>%
  unnest(mm) %>%
  dplyr::select(-data) %>% ungroup()
#save(ic50Tab, file = "ic50Tab.RData")
  
#add AUC values
load("~/Dropbox/Medizin/Forschung/Aktuelle Forschungsprojekte/CLL CPS1000/raw data/ic50Tab.RData")
aucTab <- group_by(df_all, diagnosis, patientID, drug) %>%
  summarise(meanViab = mean(viability, na.rm = TRUE)) |> 
  dplyr::rename(Drug = drug)
ic50Tab <- left_join(ic50Tab, aucTab, by = c("patientID", "Drug")) %>%
  mutate(IC50 = exp(1)^IC50,
         pIC50 = -log10(IC50))
         
#Distribution of parameters 
plotTab <- ic50Tab %>% dplyr::select(HS, Einf, pF, R2, AUC, meanViab) %>%
  pivot_longer(everything(),names_to = "parameter", values_to = "value") %>%
  dplyr::filter(!is.na(value)) 
ggplot(plotTab, aes(x=value)) +
  geom_histogram(bins = 500) +
  facet_wrap(~parameter, scales = "free")    
  
#filter
ic50Tab <- mutate(ic50Tab, response =  HS > 0.25 &  pF < 0.01 &  Einf < 1) %>%
  mutate(group = case_when(
    is.na(response) ~ "failed",
    !response ~ "no response",
    response & R2 < 0.6 ~ "non-determined",
    TRUE ~ "response"
  ))  
  
#Distribution of parameters after filtering
ic50Tab.sig <- dplyr::filter(ic50Tab, group == "response")

plotTab <- ic50Tab.sig %>% dplyr::select(HS, Einf, pF, R2, AUC, pIC50, meanViab) %>%
  pivot_longer(everything(),names_to = "parameter", values_to = "value") %>%
  dplyr::filter(!is.na(value)) 
ggplot(plotTab, aes(x=value)) +
  geom_histogram(bins = 100) +
  facet_wrap(~parameter, scales = "free")  
  
#Compare the distribution of sucessful fit
sumGroup <- group_by(ic50Tab, Drug, group) %>%
  summarise(n = length(patientID))
sumResGroup <- dplyr::filter(sumGroup, group == "response") %>% 
  arrange(n)
  
fit_color <- setNames(c("blue", "red", "grey"), c("response", "no response", "failed"))  

#successful fit in CLL
sumGroup_cll <- ic50Tab   |> 
  filter(diagnosis %in% c("CLL")) |> 
  group_by(Drug, group) %>%
  summarise(n = length(patientID)) 
drug_list_response <- sumGroup_cll |> 
  filter(group == "failed") |> 
  group_by(Drug) |> 
  arrange(desc(n)) |> 
  pull(Drug)
sumGroup_cll$Drug <- factor(sumGroup_cll$Drug, levels = drug_list_response)

fit1 <- sumGroup_cll |> 
filter(!is.na(Drug)) |> 
ggplot(aes(y=Drug, x = n, fill = group)) + geom_bar(stat = "identity", alpha=0.8)+
theme_classic()+
    labs(title = "CLL", x = "Number of samples", y = "", fill="Dose-response curve")+
    theme(axis.text = element_text(color="black", size=8),
legend.position = "none", axis.line = element_line(linewidth = 0.5), axis.title = element_text(size=8), plot.title = element_text(hjust=0.5, size=8, face="bold"))+
scale_fill_manual(values=fit_color)

#successful fit in AML
sumGroup_aml <- ic50Tab   |> 
  filter(diagnosis %in% c("AML")) |> 
  group_by(Drug, group) %>%
  summarise(n = length(patientID)) 
drug_list_response <- sumGroup_aml |> 
  filter(group == "failed") |> 
  group_by(Drug) |> 
  arrange(desc(n)) |> 
  pull(Drug)
sumGroup_aml$Drug <- factor(sumGroup_aml$Drug, levels = drug_list_response)

fit2 <- sumGroup_aml |> 
filter(!is.na(Drug)) |> 
ggplot(aes(y=Drug, x = n, fill = group)) + geom_bar(stat = "identity", alpha=0.8)+
theme_classic()+
    labs(title = "AML", x = "Number of samples", y = "", fill="Dose-response curve")+
    theme(axis.text = element_text(color="black", size=8),
legend.title = element_text(size=8, face="bold"), legend.text=element_text(size=8), axis.line = element_line(linewidth = 0.5), axis.title = element_text(size=8), plot.title = element_text(hjust=0.5, size=8, face="bold"))+
scale_fill_manual(values=fit_color)

FigS11a <- fit1+fit2
FigS11a

# Compare AUC with mean viability
## All drugs together
plotTab <- ic50Tab %>% mutate(AUC= ifelse(is.na(AUC),1,AUC))
plotTab |> 
#filter(group == "response") |> 
ggplot(aes(x=AUC,y=meanViab)) + geom_point(aes(col = group), alpha=0.25) +
  geom_smooth(method = "lm", se=FALSE) +
  theme_bw() +
  ylab("mean viability") +xlab("AUC under sigmoid curve")

## Compare AUC with mean viability for each drug
pList <- lapply(unique(ic50Tab$Drug), function(dd) {
  plotTab <- dplyr::filter(ic50Tab, Drug == dd) %>%
    mutate(AUC = ifelse(is.na(AUC),1,AUC))
  ggplot(plotTab, aes(x=meanViab,y=AUC)) + geom_point(aes(col = group)) +
    theme_bw() + xlab("mean viability") + ylab("AUC under sigmod curve") +
    ggtitle(dd)
})

#jyluMisc::makepdf(pList, "mean_vs_AUC_compare.pdf", ncol=3, nrow=3, width = 12, height = 10)

#plot failed by drug
ic50Tab |> 
    dplyr::filter(group == "failed") |> 
    ggplot(aes(x=Drug))+ 
    geom_bar()+
    coord_flip()
  
#calculate disease-specific and overall median and coeff. of variation of all parameters
param_list <- colnames(ic50Tab[,3:10])

#remove HS=4
#ic50Tab <- ic50Tab |>
#  filter(HS!= 4)

#overall parameters
ic50Tab_all <- ic50Tab |> 
    group_by(Drug) |> 
    mutate(
    all_median_HS = median(HS, na.rm = TRUE), all_cov_HS = mean(HS, na.rm = TRUE)/sd(HS, na.rm = TRUE),
    all_median_Einf = median(Einf, na.rm = TRUE), all_cov_Einf = mean(Einf, na.rm = TRUE)/sd(Einf, na.rm = TRUE),
    all_median_IC50 = median(IC50, na.rm = TRUE), all_cov_IC50 = mean(IC50, na.rm = TRUE)/sd(IC50, na.rm = TRUE),
    all_median_pF = median(pF, na.rm = TRUE), all_cov_pF = mean(pF, na.rm = TRUE)/sd(pF, na.rm = TRUE),
    all_median_R2 = median(R2, na.rm = TRUE), all_cov_R2 = mean(R2, na.rm = TRUE)/sd(R2, na.rm = TRUE),
    all_median_AUC = median(AUC, na.rm = TRUE), all_cov_AUC = mean(AUC, na.rm = TRUE)/sd(AUC, na.rm = TRUE),
    all_median_meanViab = median(meanViab, na.rm = TRUE), all_cov_meanViab = mean(meanViab, na.rm = TRUE)/sd(meanViab, na.rm = TRUE),
    all_median_pIC50 = median(pIC50, na.rm = TRUE), all_cov_pIC50 = mean(pIC50, na.rm = TRUE)/sd(pIC50, na.rm = TRUE)
    )

#disease_specific parameters: use means
ic50Tab_disease <- ic50Tab_all |>
    dplyr::filter(group != "failed") |> 
    group_by(diagnosis, Drug) |> 
    summarize(
        dis_mean_HS = mean(HS, na.rm = TRUE), dis_cov_HS = mean(HS, na.rm = TRUE)/sd(HS, na.rm = TRUE),
    dis_mean_Einf = mean(Einf, na.rm = TRUE), dis_cov_Einf = mean(Einf, na.rm = TRUE)/sd(Einf, na.rm = TRUE),
    dis_mean_IC50 = mean(IC50, na.rm = TRUE), dis_cov_IC50 = mean(IC50, na.rm = TRUE)/sd(IC50, na.rm = TRUE),
    dis_mean_pF = mean(pF, na.rm = TRUE), dis_cov_pF = mean(pF, na.rm = TRUE)/sd(pF, na.rm = TRUE),
    dis_mean_R2 = mean(R2, na.rm = TRUE), dis_cov_R2 = mean(R2, na.rm = TRUE)/sd(R2, na.rm = TRUE),
    dis_mean_AUC = mean(AUC, na.rm = TRUE), dis_cov_AUC = mean(AUC, na.rm = TRUE)/sd(AUC, na.rm = TRUE),
    dis_median_meanViab = median(meanViab, na.rm = TRUE), dis_cov_meanViab = mean(meanViab, na.rm = TRUE)/sd(meanViab, na.rm = TRUE),
    dis_mean_pIC50 = mean(pIC50, na.rm = TRUE), dis_cov_pIC50 = mean(pIC50, na.rm = TRUE)/sd(pIC50, na.rm = TRUE))
    
#remove columns with NA
ic50Tab_disease <- ic50Tab_disease |> 
  filter(!is.na(dis_cov_IC50)) |> 
  dplyr::select(-c(dis_cov_IC50, dis_cov_pIC50))


#merge response data with disease-specific coefficients for AML and CLL
CLL_df <- ic50Tab_disease |> 
  dplyr::filter(diagnosis == "CLL") |> 
  merge(plotTab.cll, by.x="Drug", by.y="drug") |> 
  merge(ORR_CLL, by.x="Drug", by.y="drug")

AML_df <- ic50Tab_disease |> 
  dplyr::filter(diagnosis == "AML") |> 
  merge(plotTab.aml, by.x="Drug", by.y="drug") |> 
  merge(ORR_AML, by.x="Drug", by.y="drug")  
  
#load drug class
category <- read.csv("~/Dropbox/Medizin/Forschung/Aktuelle Forschungsprojekte/CLL CPS1000/analysis/drugCategory_modified.csv", sep=";") |> dplyr::select(drug, Category)

CLL_df <- merge(CLL_df, category, by.x="Drug", by.y="drug")
CLL_df$Category <- factor(CLL_df$Category, levels=unique(CLL_df$Category))

AML_df <- merge(AML_df, category, by.x="Drug", by.y="drug")
AML_df$Category <- factor(AML_df$Category, levels=unique(AML_df$Category))

mycolors <- c("Chemo" = "gray50", 
                    "Kinase" = "#6A3D9A", 
                    "Other" = "#CAB2D6")

#plots
library(ggpmisc)

#Mean viab vs ORR
CLL_df$nr_pat <- as.numeric(CLL_df$nr_pat)
AML_df$nr_pat <- as.numeric(AML_df$nr_pat)

p1 <- CLL_df |> 
    ggplot(aes(x=dis_median_meanViab, y=ORR, color=Category)) +
    geom_point(aes(size=nr_pat)) +
    geom_text_repel(aes(label=Drug), size=3, color="black", 
      box.padding = 0.5,
      point.padding = 0.75,
      min.segment.length = 1)+
    theme_bw()+
    labs(title = "CLL", x = "Mean viability", y = "ORR", color="Drug type", size="Nr. of patients\nin study")+
    theme(axis.text = element_text(color="black", size=8),
legend.title = element_text(size=8, face="bold"), legend.text=element_text(size=8), axis.title = element_text(size=8), plot.title = element_text(hjust=0.5, size=8, face="bold"))+
scale_color_manual(values=mycolors)+
theme(legend.position = "none")  

#adjust:create the filtered dataset and fit the model
filtered_data <- CLL_df |> 
  filter(!(Drug %in% c("Ibrutinib", "Duvelisib", "Idelalisib", "ONO.4059", "Sunitinib", "Dasatinib")))

lm_model <- lm(ORR ~ dis_median_meanViab, data = filtered_data)

pred_data <- data.frame(dis_median_meanViab = seq(
  min(filtered_data$dis_median_meanViab, na.rm = TRUE),
  max(filtered_data$dis_median_meanViab, na.rm = TRUE),
  length.out = 100))

pred_data$ORR <- predict(lm_model, newdata = pred_data)
pred_data$se <- predict(lm_model, newdata = pred_data, se.fit = TRUE)$se.fit
pred_data$lower <- pred_data$ORR - 1.96 * pred_data$se
pred_data$upper <- pred_data$ORR + 1.96 * pred_data$se

p1 <- p1+ geom_ribbon(data = pred_data, 
                 aes(x = dis_median_meanViab, y = ORR, ymin = lower, ymax = upper),
                 fill = "lightgrey", alpha = 0.35, inherit.aes = FALSE)+
      ylim(0,NA)
  

p2 <- AML_df |> 
    ggplot(aes(x=dis_median_meanViab, y=ORR, color=Category)) +
    geom_point(aes(size=nr_pat)) +
    geom_text_repel(aes(label=Drug), size=3, color="black",
    box.padding = 0.5)+
    theme_bw()+
    labs(title = "AML", x = "Mean viability", y = "ORR", color="Drug type", size="Nr. of patients\nin study")+
    theme(axis.text = element_text(color="black", size=8),
legend.title = element_text(size=8, face="bold"), legend.text=element_text(size=8), axis.title = element_text(size=8), plot.title = element_text(hjust=0.5, size=8, face="bold"))+
scale_color_manual(values=mycolors, labels = c("Kinase inhibitor", "Chemotherapy", "Other"))+
scale_size_continuous(
    breaks=c(50,100,150,200),
    labels =c(50,100,150,200)) 
    

library(patchwork)
Fig7a <- p1+p2
Fig7a


#make clean tables for linear regression of ORR
# Remove rows with missing ORR values
# remove dis_mean_R2 from model
CLL_clean <- CLL_df[!is.na(CLL_df$ORR), ] |> 
  dplyr::select(-diagCompare, -diagBase)
AML_clean <- AML_df[!is.na(AML_df$ORR), ] |> 
  dplyr::select(-diagCompare, -diagBase)

# Select predictor variables (from dose-response curve)
CLL_predictors <- CLL_clean[, c(3:16)]
AML_predictors <- AML_clean[, c(3:16)]

CLL_outcome <- CLL_clean$ORR
AML_outcome <- AML_clean$ORR

# Correlation analysis to identify multicollinearity: CLL
cor_matrix <- cor(CLL_predictors, use = "complete.obs")
corrplot(cor_matrix, method = "color", type = "upper", 
         tl.cex = 0.8, tl.col = "black", tl.srt = 45)
         
#remove dis_mean_R2 and dis_cov_R2 for the stability of the model 
CLL_predictors <- CLL_predictors |> 
 dplyr::select(-dis_mean_R2, -dis_cov_R2)
         
# Correlation analysis to identify multicollinearity: AML
cor_matrix <- cor(AML_predictors, use = "complete.obs")
corrplot(cor_matrix, method = "color", type = "upper", 
         tl.cex = 0.8, tl.col = "black", tl.srt = 45) 

#lasso for CLL
set.seed(456)
#response variable
y <- CLL_outcome 
#predictors
x <- data.matrix(CLL_predictors)

cv_model <- cv.glmnet(x,y,alpha=1)
best_lambda <- cv_model$lambda.min
best_lambda
plot(cv_model)
best_model <- glmnet(x,y,alpha=1, lambda=best_lambda)
coef(best_model)

# -> dis_mean_HS + dis_medianViab

model <- lm(ORR ~ dis_mean_HS+dis_median_meanViab, data = CLL_df)
summary(model)
summary(model)$r.squared

par(mfrow = c(2, 2))
plot(model)

#lasso for AML
set.seed(123)
#response variable
y <- AML_outcome
#predictors
x <- data.matrix(AML_predictors)

cv_model <- cv.glmnet(x,y,alpha=1)
best_lambda <- cv_model$lambda.min
best_lambda
plot(cv_model)
best_model <- glmnet(x,y,alpha=1, lambda=best_lambda)
coef(best_model)

# -> no correlation

#plot median HS vs ORR in CLL
FigS11b <- CLL_clean |> 
    ggplot(aes(x=dis_mean_HS, y=ORR, color=dis_mean_AUC)) +
    geom_point(aes(size=nr_pat)) +
    geom_text_repel(aes(label=Drug), size=3, color="black",
      point.padding = 1,
      box.padding = 0.5,
      min.segment.length = 0.5)+
      stat_poly_line(col="grey40", linewidth=0.5, se=FALSE, linetype="dashed") +
      stat_poly_eq(use_label("R2", "P"), label.x = "right", size=3) +
    #geom_smooth(method="lm", col="black", linewidth=0.5, se=TRUE) +
    theme_bw()+
    labs(title = "CLL", x = "Mean Hill coefficient", y = "ORR", color="Mean AUC", size="Nr. of patients\nin study")+
    theme(axis.text = element_text(color="black", size=8),
legend.title = element_text(size=8, face="bold"), legend.text=element_text(size=8), axis.title = element_text(size=8), plot.title = element_text(hjust=0.5, size=8, face="bold"))+
scale_color_gradientn(colors=c("blue", "red"))
FigS11b

#plot distribution of Hill coefficient
drug_list_HS <- CLL_clean |> 
  arrange(desc(ORR)) |> 
  pull(Drug)

hs_distr <- ic50Tab |> 
  filter(diagnosis == "CLL", Drug %in% CLL_clean$Drug, group != "failed") |> 
  as.data.frame() |> 
  dplyr::select(Drug, HS, AUC)
  
hs_distr$Drug <- factor(hs_distr$Drug, levels = drug_list)  
  
hs_distr |>   
#filter(HS <4) |> 
filter(!is.na(AUC)) |> 
group_by(Drug) |> 
mutate(mean_Hs = mean(HS)) |> 
ggplot(aes(x=HS, y=Drug, color=AUC)) +
geom_boxplot(outliers = FALSE)+
geom_jitter(
#width=0.15, 
height=0.15, 
alpha=0.3)+
geom_point(aes(x=mean_Hs, y=Drug), color="black")+
theme_classic()+
theme(axis.text = element_text(color="black", size=8),
legend.title = element_text(size=8, face="bold"), legend.text=element_text(size=8), axis.line = element_line(linewidth = 0.5), axis.title = element_text(size=8), plot.title = element_text(hjust=0.5, size=8, face="bold"))+
scale_color_gradientn(colors=c("blue", "red"))+
labs(x="Hill coefficient", y="")

#same for CRR
# Remove rows with missing CR values
CLL_clean <- CLL_df[!is.na(CLL_df$CR), ] |> 
  dplyr::select(-diagCompare, -diagBase)
AML_clean <- AML_df[!is.na(AML_df$CR), ] |> 
  dplyr::select(-diagCompare, -diagBase)
  
# Select predictor variables (from dose-response curve)
CLL_predictors <- CLL_clean[, c(3:16)]
AML_predictors <- AML_clean[, c(3:16)]  

CLL_outcome <- CLL_clean$CR
AML_outcome <- AML_clean$CR

#lasso for CLL
set.seed(1234)
#response variable
y <- CLL_outcome 
#predictors
x <- data.matrix(CLL_predictors)

cv_model <- cv.glmnet(x,y,alpha=1)
best_lambda <- cv_model$lambda.min
best_lambda
plot(cv_model)
best_model <- glmnet(x,y,alpha=1, lambda=best_lambda)
coef(best_model)

# -> dis_median_meanViab

#lasso for AML
set.seed(1234)
#response variable
y <- AML_outcome
#predictors
x <- data.matrix(AML_predictors)

cv_model <- cv.glmnet(x,y,alpha=1)
best_lambda <- cv_model$lambda.min
best_lambda
plot(cv_model)
best_model <- glmnet(x,y,alpha=1, lambda=best_lambda)
coef(best_model)

# -> no association

#plot for CLL
p3 <- CLL_clean |> 
    ggplot(aes(x=dis_median_meanViab, y=CR)) +
    geom_smooth(method="lm", col="lightgrey", linewidth=0.5, se=FALSE,alpha=0.5,linetype="dashed") +
    geom_point(aes(size=nr_pat, color=Category)) +
    geom_text_repel(aes(label=Drug), size=3, color="black",
      box.padding = 0.5,
      point.padding = 0.5,
      max.overlaps=5)+
      #stat_poly_line(col="grey40", linewidth=0.5, se=TRUE) +
      stat_poly_eq(use_label("R2", "P"), label.x = "right", size=3) +
    theme_bw()+
    labs(title = "CLL", x = "Mean viability", y = "CRR", color="Drug type", size="Nr. of patients\nin study")+
    theme(axis.text = element_text(color="black", size=8),
legend.title = element_text(size=8, face="bold"), legend.text=element_text(size=8), axis.title = element_text(size=8), plot.title = element_text(hjust=0.5, size=8, face="bold"))+
scale_color_manual(values=mycolors, labels = c("Kinase inhibitor", "Chemotherapy", "Other"))+
theme(legend.position = "none")+
ylim(0, NA)

#plot for AML
p4 <- AML_clean |> 
    ggplot(aes(x=dis_median_meanViab, y=CR)) +
    geom_point(aes(size=nr_pat, color=Category)) +
    geom_text_repel(aes(label=Drug), size=3, color="black",
      box.padding = 0.5,
      point.padding = 0.5,
      max.overlaps=5)+
#stat_poly_line(col="black", linewidth=0.5, se=FALSE) +
    stat_poly_eq(use_label("R2", "P"), label.x = "right", size=3) +
    theme_bw()+
    labs(title = "AML", x = "Mean viability", y = "CRR", color="Drug type", size="Nr. of patients\nin study")+
    theme(axis.text = element_text(color="black", size=8),
legend.title = element_text(size=8, face="bold"), legend.text=element_text(size=8), axis.title = element_text(size=8), plot.title = element_text(hjust=0.5, size=8, face="bold"))+
scale_color_manual(values=mycolors, labels = c("Kinase inhibitor", "Chemotherapy", "Other"))+
scale_size_continuous(
    breaks=c(50,100,150,200),
    labels =c(50,100,150,200))+
    ylim(0,60)

Fig7b <- p3+p4 + theme(plot.margin = margin(t=1, b=1, l=1, r=1, unit = "cm"))
Fig7b


#plot for all drugs
model <- lm(CR ~ dis_median_meanViab, data = CLL_df)
summary(model)
summary(model)$r.squared

ic50Tab_disease |> 
  filter(diagnosis == "CLL") |> 
  mutate(CRR = 64.50 - 70.56 * dis_median_meanViab) |> 
  ggplot(aes(x=dis_median_meanViab, y=CRR))+
  geom_point()+
  geom_text_repel(aes(label=Drug), size=3, color="black",
      box.padding = 0.5,
      point.padding = 0.75,
      min.segment.length = 1)

